{% extends "base.html" %}
{% block content %}
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h1 class="h4">Balances</h1>
    {% if session.house_id %}
    <button class="btn btn-sm btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#payModal">Record Payment</button>
    {% endif %}
  </div>

  <div class="card mb-3">
    <div class="card-body p-0">
      <table class="table mb-0 table-sm align-middle">
        <thead>
          <tr>
            <th>From \ To</th>
            {% for h in houses %}<th>{{ h.name }}</th>{% endfor %}
          </tr>
        </thead>
        <tbody>
          {% for i in houses %}
            <tr>
              <th>{{ i.name }}</th>
              {% for j in houses %}
                {% if i.id == j.id %}
                  <td class="text-center text-muted">—</td>
                {% else %}
                  {% set val = matrix.get((i.id, j.id), 0.0) %}
                  <td class="{{ 'text-danger' if val>0 else 'text-success' if val<0 else '' }}">
                    €{{ '%.2f'|format(val) }}
                  </td>
                {% endif %}
              {% endfor %}
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <div class="card">
    <div class="card-header">Recent Ledger Entries</div>
    <div class="card-body p-0">
      <table class="table mb-0 table-sm align-middle">
        <thead><tr><th>Date</th><th>From</th><th>To</th><th>Type</th><th>Amount</th><th>Description</th></tr></thead>
        <tbody>
          {% for e in recent_entries %}
            <tr>
              <td>{{ e.created_at.strftime("%Y-%m-%d %H:%M") }}</td>
              <td>{{ e.from_house.name }}</td>
              <td>{{ e.to_house.name }}</td>
              <td><span class="badge text-bg-{{ 'secondary' if e.entry_type=='payment' else 'primary' }}">{{ e.entry_type }}</span></td>
              <td>€{{ '%.2f'|format(e.amount) }}</td>
              <td>{{ e.description }}</td>
            </tr>
          {% else %}
            <tr><td colspan="6" class="text-center text-muted p-3">No ledger entries yet.</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  {% if session.house_id %}
  <!-- Pay Modal -->
  <div class="modal fade" id="payModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <form method="post" action="{{ url_for('record_payment') }}" class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Record Payment</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">To house</label>
            <select class="form-select" name="to_house_id" required>
              <option value="">Choose…</option>
              {% for h in houses if h.id != session.house_id %}
                <option value="{{ h.id }}">{{ h.name }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="mb-3">
            <label class="form-label">Amount (€)</label>
            <input type="number" step="0.01" min="0" class="form-control" name="amount" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Note</label>
            <input class="form-control" name="note" placeholder="e.g., Revolut transfer">
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-primary">Save Payment</button>
        </div>
      </form>
    </div>
  </div>
  {% endif %}
{% endblock %}
